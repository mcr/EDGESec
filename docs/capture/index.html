<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/EDGESec/blog/rss.xml" title="EDGESec RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/EDGESec/blog/atom.xml" title="EDGESec Atom Feed"><title data-react-helmet="true">Network Capture | EDGESec</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://nqminds.github.io/EDGESec/docs/capture"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Network Capture | EDGESec"><meta data-react-helmet="true" name="description" content="The Network Capture architecture"><meta data-react-helmet="true" property="og:description" content="The Network Capture architecture"><link data-react-helmet="true" rel="shortcut icon" href="/EDGESec/img/network.svg"><link data-react-helmet="true" rel="canonical" href="https://nqminds.github.io/EDGESec/docs/capture"><link data-react-helmet="true" rel="alternate" href="https://nqminds.github.io/EDGESec/docs/capture" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://nqminds.github.io/EDGESec/docs/capture" hreflang="x-default"><link rel="stylesheet" href="/EDGESec/assets/css/styles.2a02d193.css">
<link rel="preload" href="/EDGESec/assets/js/runtime~main.46dad836.js" as="script">
<link rel="preload" href="/EDGESec/assets/js/main.8ceb7501.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_Zhym">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/EDGESec/"><div class="navbar__logo"><img src="/EDGESec/img/network.svg" alt="NQM Docusaurus Template Logo" class="themedImage_X7X7 themedImage--light_n7cD"><img src="/EDGESec/img/network.svg" alt="NQM Docusaurus Template Logo" class="themedImage_X7X7 themedImage--dark_WTCb"></div><b class="navbar__title">EDGESec</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/EDGESec/docs/">Documentation</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/EDGESec/docs/about">About</a><a href="https://github.com/nqminds/edgesec" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tjMl"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_7DKP toggle_gM5N toggleDisabled_YcJ9"><div class="toggleTrack_pr3n" role="button" tabindex="-1"><div class="toggleTrackCheck_1VIP"><span class="toggleIcon_iGPa">ðŸŒœ</span></div><div class="toggleTrackX_-cNO"><span class="toggleIcon_iGPa">ðŸŒž</span></div><div class="toggleTrackThumb_4edW"></div></div><input type="checkbox" class="toggleScreenReader_BFa8" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_ntW3"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Cy7D" type="button"></button><aside class="docSidebarContainer_ZbqI"><div class="sidebar_bpFd"><nav class="menu thin-scrollbar menu_fJBT"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Introduction</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/EDGESec/docs/">EDGESec Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/EDGESec/docs/control">Network Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/EDGESec/docs/capture">Network Capture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/EDGESec/docs/discovery">Device Discovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/EDGESec/docs/storage">Secure Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Hardware</a></li></ul></nav></div></aside><main class="docMainContainer_QBea"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_R67y"><div class="docItemContainer_fRP7"><article><div class="tocCollapsible_caTw theme-doc-toc-mobile tocMobile_QgRD"><button type="button" class="clean-btn tocCollapsibleButton_YFWb">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Network Capture</h1></header><h2 class="anchor anchorWithStickyNavbar_7Y9k" id="the-network-capture-architecture">The Network Capture architecture<a aria-hidden="true" class="hash-link" href="#the-network-capture-architecture" title="Direct link to heading">â€‹</a></h2><p>The network capture has the purpose of monitoring network traffic for each connected device. The resulting traffic analytics is sent to the network controller for device management. The network capture contains the following services:</p><ul><li>Packet decoder</li><li>Packet capture</li><li>SQLite header storer</li><li>Raw packet storer</li><li>GRPC Synchroniser</li><li>Device monitoring</li></ul><p>The capture service is implemented as a standalone executable that can be run on demand by the network controller. The configuration of the capture service is depicted below:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT c"><pre tabindex="0" class="prism-code language-c codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">capture_conf</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> capture_interface</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">IFNAMSIZ</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  bool promiscuous</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  bool immediate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint16_t</span><span class="token plain"> buffer_timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint16_t</span><span class="token plain"> process_interval</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  bool file_write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  bool db_write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  bool db_sync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> db_path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MAX_OS_PATH_LEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> db_sync_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MAX_WEB_PATH_LEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint16_t</span><span class="token plain"> db_sync_port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">filter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><p>The capture service can be run on a given network interface with a given filter. The capture also has the ability to store the processed packet in SQLite databases or raw format. The databases can be synchronised with the cloud for remote access.</p><h2 class="anchor anchorWithStickyNavbar_7Y9k" id="packet-decoder">Packet decoder<a aria-hidden="true" class="hash-link" href="#packet-decoder" title="Direct link to heading">â€‹</a></h2><p>The packet decoder extract the metadata from captured packet. The below structure represents all the protocols that are currently being decoded:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT c"><pre tabindex="0" class="prism-code language-c codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">capture_packet</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">ether_header</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ethh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">ether_arp</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">arph</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">ip</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ip4h</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">ip6_hdr</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ip6h</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">tcphdr</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">tcph</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">udphdr</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">udph</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">icmphdr</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">icmp4h</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">icmp6_hdr</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">icmp6h</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">dns_header</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">dnsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">mdns_header</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">mdnsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">dhcp_header</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">dhcph</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint64_t</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> caplen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> length</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> ethh_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> arph_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> ip4h_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> ip6h_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> tcph_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> udph_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> icmp4h_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> icmp6h_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> dnsh_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> mdnsh_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 107)">uint32_t</span><span class="token plain"> dhcph_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> count</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><p>For each decoded packet the service stores the hash of the header as well as the timestamp.</p><h2 class="anchor anchorWithStickyNavbar_7Y9k" id="packet-capture">Packet capture<a aria-hidden="true" class="hash-link" href="#packet-capture" title="Direct link to heading">â€‹</a></h2><p>The packet capture implements the actual network sniffing process. Currently it uses pcap library. But it also allow interfacing with PF_RING module that implements zero-copy technique.</p><h2 class="anchor anchorWithStickyNavbar_7Y9k" id="sqlite-storer">SQLite storer<a aria-hidden="true" class="hash-link" href="#sqlite-storer" title="Direct link to heading">â€‹</a></h2><p>The SQLite storer implements the storage process for packet metadata into sqlite databases. Below is the list of schemas created by the SQLite storer that can be used by any application to query the packets:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT"><pre tabindex="0" class="prism-code language-undefined codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE eth (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, ether_dhost TEXT, ether_shost TEXT, ether_type INTEGER,PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE arp (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, arp_hrd INTEGER, arp_pro INTEGER, arp_hln INTEGER, arp_pln INTEGER, arp_op INTEGER, arp_sha TEXT, arp_spa TEXT, arp_tha TEXT, arp_tpa TEXT, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE ip4 (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, ip_hl INTEGER, ip_v INTEGER, ip_tos INTEGER, ip_len INTEGER, ip_id INTEGER, ip_off INTEGER, ip_ttl INTEGER, ip_p INTEGER, ip_sum INTEGER, ip_src TEXT, ip_dst TEXT, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE ip6 (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, ip6_un1_flow INTEGER, ip6_un1_plen INTEGER, ip6_un1_nxt INTEGER, cip6_un1_hlim INTEGER, ip6_un2_vfc INTEGER, ip6_src TEXT, ip6_dst TEXT, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE tcp (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, source INTEGER, dest INTEGER, seq INTEGER, ack_seq INTEGER, res1 INTEGER, doff INTEGER, fin INTEGER, syn INTEGER, rst INTEGER, psh INTEGER, ack INTEGER, urg INTEGER, window INTEGER, check_p INTEGER, urg_ptr INTEGER, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE udp (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, source INTEGER, dest INTEGER, len INTEGER, check_p INTEGER, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE icmp4 (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, type INTEGER, code INTEGER, checksum INTEGER, gateway INTEGER, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE icmp6 (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, icmp6_type INTEGER, icmp6_code INTEGER, icmp6_cksum INTEGER, icmp6_un_data32 INTEGER, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE dns (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, tid INTEGER, flags INTEGER, nqueries INTEGER, nanswers INTEGER, nauth INTEGER, nother INTEGER, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE mdns (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, tid INTEGER, flags INTEGER, nqueries INTEGER, nanswers INTEGER, nauth INTEGER, nother INTEGER, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE dhcp (hash INTEGER NOT NULL, timestamp INTEGER NOT NULL, ethh_hash INTEGER NOT NULL, caplen INTEGER, length INTEGER, op INTEGER, htype INTEGER, hlen INTEGER, hops INTEGER, xid INTEGER, secs INTEGER, flags INTEGER, ciaddr TEXT, yiaddr TEXT, siaddr TEXT, giaddr TEXT, PRIMARY KEY (hash, timestamp, ethh_hash))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><p>Ever column in the respective table contains the hash of the Ethernet protocol that encapsulated the upper layers of the internet protocol suite as well as the capture timestamp.</p><h2 class="anchor anchorWithStickyNavbar_7Y9k" id="raw-packet-storer">Raw packet storer<a aria-hidden="true" class="hash-link" href="#raw-packet-storer" title="Direct link to heading">â€‹</a></h2><p>The raw packet storer stores the raw packet into pcap files and the metadata for each file is stored in a SQLite database. The file name for each packet is randomly generate and subsequently the name is stored in a SQLite database together with the timestamp and packet length. The schema for the SQLite database is depicted below:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT"><pre tabindex="0" class="prism-code language-undefined codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE meta (id TEXT, timestamp INTEGER NOT NULL, name TEXT, interface TEXT, filter TEXT, caplen INTEGER, length INTEGER, PRIMARY KEY (id, timestamp, interface))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_7Y9k" id="grpc-synchroniser">GRPC Synchroniser<a aria-hidden="true" class="hash-link" href="#grpc-synchroniser" title="Direct link to heading">â€‹</a></h2><p>The GRPC syncroniser service implements the syncronisation process to the cloud for stored packet data as well as other tool data. The syncroniser can function in two ways:</p><ul><li>Forward - the syncroniser pushes the tool data to a cloud endpoint</li><li>Reverse - the syncroniser connects to a cloud endpoint, which subsequently makes a reverse connection to the syncroniser service</li></ul><p>The syncronisation process is based on gRPC protocol, where the syncroniser service acts as a client and the cloud endpoint as a server. The connection can be made secure (using TLS) by providing a server certificate.</p><p>The gRPC protocol uses procol buffers to define the remote execution function. The forward service is implemented by the below protocol buffer:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT"><pre tabindex="0" class="prism-code language-undefined codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token plain">syntax = &quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">package sqlite_sync;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// The synchroniser service definition.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">service Synchroniser {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // Registers a db</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  rpc RegisterDb (RegisterDbRequest) returns (RegisterDbReply) {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // Synchronise db statement</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  rpc SyncDbStatement (SyncDbStatementRequest) returns (SyncDbStatementReply) {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// The request message containing the db name and other params.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">message RegisterDbRequest {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  string name = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// The response message containing the registration status</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">message RegisterDbReply {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  uint32 status = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">message SyncDbStatementRequest {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  string name = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  string statement = 2;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">message SyncDbStatementReply {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  uint32 status = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><p>The forward synchroniser is used for cases when one needs to syncronise only the metadata to the cloud. It is implemented as a queue that pushes the packets at given intervals of time.</p><h2 class="anchor anchorWithStickyNavbar_7Y9k" id="device-monitoring">Device monitoring<a aria-hidden="true" class="hash-link" href="#device-monitoring" title="Direct link to heading">â€‹</a></h2><p>The device monitoring service decodes the network traffic and assembles nettwork flow. Each flow is denoted by a source and destination MAC address, and protcol type. For each flow the device monitoring service calculates a fingerpint using the SHA256 algorithm.</p><p>The flow results in the following structure:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT c"><pre tabindex="0" class="prism-code language-c codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">nDPI_flow_meta</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> src_mac_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MACSTR_LEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> dst_mac_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MACSTR_LEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MAX_PROTOCOL_NAME_LEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">SHA256_HASH_LEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MAX_QUERY_LEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><p>where <strong>src_mac_addr</strong> is the source MAC address, <strong>dst_mac_addr</strong> is the destination MAC address, <strong>protocol</strong> is the ID of the identified network protocol, <strong>hash</strong> is the fingerprint of the flow and <strong>query</strong> is the optional query string. The optional <strong>query</strong> string is dependent on the protocol type. For DNS, mDNS and TLS it is the same as the requested host name.</p><p>Each flow is stored in a sqlite database with teh followinf schema:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT"><pre tabindex="0" class="prism-code language-undefined codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE fingerprint (mac TEXT NOT NULL, protocol TEXT, fingerprint TEXT, timestamp INTEGER NOT NULL, query TEXT, PRIMARY KEY (mac, timestamp));</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><p>The timestamp is given as 64 bit microseconds value and the fingerprint string is encoded in base64.</p><p>An example of the fingerprint table rows are below:</p><table><thead><tr><th>MACPROTOCOL</th><th>FINGERPRINT</th><th>TIMESTAMP</th><th>QUERY</th></tr></thead><tbody><tr><td>84:e3:42:3a:cb:2f</td><td>TLS.Amazon</td><td>mI1ENXMPBQDVjwGh/o0bLSrD8+O2O5RCFQLbUVt4lzI</td><td>1625055051481102</td></tr><tr><td>9c:ef:d5:fd:db:56</td><td>TLS.Amazon</td><td>mI1ENXMPBQDVjwGh/o0bLSrD8+O2O5RCFQLbUVt4lzI</td><td>1625055051481102</td></tr><tr><td>84:e3:42:3a:cb:2f</td><td>DNS</td><td>NqRTRWiNdfG4zMkiXE9P0eRQIefPgMYV/vXUymxdvNw</td><td>1625055072748967</td></tr><tr><td>9c:ef:d5:fd:db:56</td><td>DNS</td><td>NqRTRWiNdfG4zMkiXE9P0eRQIefPgMYV/vXUymxdvNw</td><td>1625055072748967</td></tr></tbody></table><p>The entries of the fingerprint table can be queried using the supervisor service.</p><p>For instance to retrieve all fingerprints for the MAC address 84:e3:42:3a:cb:2f one could use the following command:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT"><pre tabindex="0" class="prism-code language-undefined codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUERY_FINGERPRINT 84:e3:42:3a:cb:2f 0 &gt;= all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><p>To retrieve all the fingerprints up to a given timestamp one could use the following command:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT"><pre tabindex="0" class="prism-code language-undefined codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUERY_FINGERPRINT 84:e3:42:3a:cb:2f 1625055051481102 &lt;= all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div><p>To retrieve all the fingerprints for the DNS protocol one could use the following command:</p><div class="codeBlockContainer_8VJT"><div class="codeBlockContent_meoT"><pre tabindex="0" class="prism-code language-undefined codeBlock_ltyB thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ZWp2"><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUERY_FINGERPRINT 84:e3:42:3a:cb:2f 0 &gt;= DNS</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_TFIO clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/nqminds/docusaurus-template/edit/master/docs/capture.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_QGlx" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_+nfr"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/EDGESec/docs/control"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Network Control</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/EDGESec/docs/discovery"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Device Discovery<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_1gSR thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-network-capture-architecture" class="table-of-contents__link toc-highlight">The Network Capture architecture</a></li><li><a href="#packet-decoder" class="table-of-contents__link toc-highlight">Packet decoder</a></li><li><a href="#packet-capture" class="table-of-contents__link toc-highlight">Packet capture</a></li><li><a href="#sqlite-storer" class="table-of-contents__link toc-highlight">SQLite storer</a></li><li><a href="#raw-packet-storer" class="table-of-contents__link toc-highlight">Raw packet storer</a></li><li><a href="#grpc-synchroniser" class="table-of-contents__link toc-highlight">GRPC Synchroniser</a></li><li><a href="#device-monitoring" class="table-of-contents__link toc-highlight">Device monitoring</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contact Us</div><ul class="footer__items"><li class="footer__item"><a href="http://nqmcyber.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tjMl"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 NQMCyber LTD.<br>Built with Docusaurus.</div></div></div></footer></div>
<script src="/EDGESec/assets/js/runtime~main.46dad836.js"></script>
<script src="/EDGESec/assets/js/main.8ceb7501.js"></script>
</body>
</html>